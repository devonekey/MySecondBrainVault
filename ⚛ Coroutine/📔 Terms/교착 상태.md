---
aliases:
  - Deadlock
importance: Medium
originated from:
  - "[[📘 코틀린 동시성 프로그래밍/1장 - Hello, Concurrent World!]]"
answered by:
  - Book
  - OpenAI
tags:
  - Coroutine
  - 코루틴
  - Terms
  - 주요_개념
learned:
---
##### ℹ️ Description
---
- [스레드](스레드.md) 또는 [코루틴](코루틴.md) 같은 여러 실행 흐름이 서로가 가진 자원을 기다리며무한히 대기하는 문제

##### 🔥 How does it occur?
---
```Kotlin
fun main() = runBlocking<Unit> {
    val mutexA = Mutex()
    val mutexB = Mutex()
    
    launch(context = CoroutineName("Coroutine 1")) {
	    val name = coroutineContext[CoroutineName]?.name
	    
	    println("$name is started...")
        
        mutexA.lock()
        
        println("$name: Mutex A is locked...")
        
        delay(100)
        mutexB.lock()
        
        println("$name: Mutex B is locked...")
        
        mutexA.unlock()
        mutexB.unlock()
		
		println("$name is done...")
    }
    launch(context = CoroutineName("Coroutine 2")) {
	    val name = coroutineContext[CoroutineName]?.name
	    
	    println("$name is started...")
	    
        mutexB.lock()
        
        println("$name: Mutex B is locked...")
        
        delay(100)
        mutexA.lock()
        
        println("$name: Mutex A is locked...")
        
        mutexB.unlock()
        mutexA.unlock()
		
		println("$name is done...")
    }
}
```

##### 🧯 How to handle?
---
- 락 획득 순서 일치
```Kotlin
fun main() = runBlocking<Unit> {
    val mutexA = Mutex()
    val mutexB = Mutex()
    
    launch(context = CoroutineName("Coroutine 1")) {
	    val name = coroutineContext[CoroutineName]?.name
	    
		acquireInOrder(
            name = name,
            mutexA = mutexA,
            mutexB = mutexB
        ) {
            println("$name is done...")
        }
    }
    launch(context = CoroutineName("Coroutine 2")) {
	    val name = coroutineContext[CoroutineName]?.name
	    
		acquireInOrder(
            name = name,
            mutexA = mutexA,
            mutexB = mutexB
        ) {
            println("$name is done...")
        }
    }
}

suspend fun acquireInOrder(
    name: String?,
    mutexA: Mutex,
    mutexB: Mutex,
    block: suspend () -> Unit
) {
    println("$name is started...")
    
    mutexA.lock()
    
    println("$name: Mutex A is locked...")
    
    delay(100)
    
    try {
        mutexB.lock()
        
        println("$name: Mutex B is locked...")
        
        try {
            block()
        } finally {
            mutexB.unlock()
        }
    } finally {
        mutexA.unlock()
    }
}
```
- [withTimeout](withTimeout.md)을 사용하여 오래 기다리게 되면 포기
```Kotlin
fun main() = runBlocking<Unit> {
    val mutexA = Mutex()
    val mutexB = Mutex()
    
    launch(context = CoroutineName("Coroutine 1")) {
        val name = coroutineContext[CoroutineName]?.name
        
        println("$name is started...")
        
        tryLockWithTimeout(
            name = name,
            mutex = mutexA,
            timeMillis = 100L
        )
        delay(100)
        tryLockWithTimeout(
            name = name,
            mutex = mutexB,
            timeMillis = 100L
        )
        mutexA.takeIf { it.isLocked }?.unlock()
        mutexB.takeIf { it.isLocked }?.unlock()
        
        println("$name is done...")
    }
    launch(context = CoroutineName("Coroutine 2")) {
        val name = coroutineContext[CoroutineName]?.name
        
        tryLockWithTimeout(
            name = name,
            mutex = mutexB,
            timeMillis = 100L
        )
        delay(100)
        tryLockWithTimeout(
            name = name,
            mutex = mutexA,
            timeMillis = 200L
        )
        mutexB.takeIf { it.isLocked }?.unlock()
        mutexA.takeIf { it.isLocked }?.unlock()
        
        println("$name is done...")
    }
}

suspend fun tryLockWithTimeout(
    name: String?,
    mutex: Mutex,
    timeMillis: Long
): Boolean = try {
    withTimeout(timeMillis = timeMillis) {
        mutex.lock()
        
        println("$name: Mutex is locked...")
        
        true
    }
} catch (e: TimeoutCancellationException) {
    println("$name: Mutex is cancelled...")
    
    false
}
```
